# The goal of this action is to compile the Android debug build. That should
# tell us automatically if something got broken when a dependency was changed.

name: Build Joplin Apk
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH to Action'
        required: false
        default: 'false'
  schedule:
    - cron: '0 19 * * *'

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write   
  
jobs:
  AssembleRelease:
    runs-on: ubuntu-latest
    steps:
      - name: Install Linux dependencies
        run: |
          sudo apt-get update || true
          sudo apt-get install -y libsecret-1-dev

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '20'
          
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install Yarn
        run: |
          corepack enable

      - name: Install
        run:  yarn install

      - name: Assemble Android Release
        run: |
          cd packages/app-mobile/android
          sed -i -- 's/signingConfig signingConfigs.release/signingConfig signingConfigs.debug/' app/build.gradle
          ./gradlew assembleRelease
          
      - name: SSH to Action
        uses: mxschmitt/action-tmate@master
        timeout-minutes: 30
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
          
      - name: Upload bin directory
        uses: actions/upload-artifact@main
        with:
          name: Joplin
          path: packages/app-mobile/android
